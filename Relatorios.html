<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://www.gstatic.com/charts/loader.js"></script>
  <style>
    :root {
      --bg: #f0f4f8;
      --surface: #ffffff;
      --border: #e2e8f0;
      --text: #0f172a;
      --text-muted: #64748b;
      --purple: #7c3aed;
      --purple-light: #ede9fe;
      --green: #16a34a;
      --orange: #ea580c;
      --red: #dc2626;
      --blue: #2563eb;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Plus Jakarta Sans', sans-serif;
      background: var(--bg);
      min-height: 100vh;
      padding: 24px 16px;
    }

    .wrapper { max-width: 960px; margin: 0 auto; }

    .page-header {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 28px; flex-wrap: wrap; gap: 16px;
    }
    .header-left { display: flex; align-items: center; gap: 16px; }
    .page-back {
      width: 40px; height: 40px; background: var(--surface);
      border: 1px solid var(--border); border-radius: 10px;
      display: flex; align-items: center; justify-content: center;
      color: var(--text-muted); text-decoration: none; transition: all 0.2s;
    }
    .page-back:hover { background: var(--text); color: white; }
    .page-title h1 { font-size: 22px; font-weight: 700; color: var(--text); }
    .page-title p { font-size: 13px; color: var(--text-muted); margin-top: 2px; }
    .header-actions { display: flex; gap: 10px; }
    .btn {
      padding: 10px 20px; border: none; border-radius: 10px;
      font-family: inherit; font-size: 13px; font-weight: 600; cursor: pointer;
      display: inline-flex; align-items: center; gap: 8px; transition: all 0.2s;
    }
    .btn-ghost { background: var(--surface); border: 1.5px solid var(--border); color: var(--text-muted); }
    .btn-ghost:hover { background: var(--text); color: white; border-color: var(--text); }
    .btn-green { background: var(--green); color: white; }
    .btn-green:hover { background: #15803d; }
    .btn-purple { background: var(--purple); color: white; }
    .btn-purple:hover { background: #6d28d9; }

    /* KPI GRID */
    .kpi-grid {
      display: grid; grid-template-columns: repeat(auto-fill, minmax(150px,1fr)); gap: 14px;
      margin-bottom: 24px;
    }
    .kpi-card {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 16px; padding: 20px; position: relative; overflow: hidden;
    }
    .kpi-card::before {
      content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px;
      background: var(--kpi-color, var(--purple));
    }
    .kpi-icon {
      width: 36px; height: 36px; border-radius: 8px;
      background: var(--kpi-light, var(--purple-light));
      color: var(--kpi-color, var(--purple));
      display: flex; align-items: center; justify-content: center;
      font-size: 15px; margin-bottom: 12px;
    }
    .kpi-value { font-size: 28px; font-weight: 800; color: var(--text); line-height: 1; }
    .kpi-label { font-size: 12px; color: var(--text-muted); margin-top: 4px; }

    /* CHARTS GRID */
    .charts-row {
      display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;
    }
    .chart-card {
      background: var(--surface); border: 1px solid var(--border); border-radius: 16px; overflow: hidden;
    }
    .chart-card.full { grid-column: 1 / -1; }
    .chart-header { padding: 18px 20px; border-bottom: 1px solid var(--bg); }
    .chart-header h3 { font-size: 14px; font-weight: 700; color: var(--text); display: flex; align-items: center; gap: 8px; }
    .chart-header p  { font-size: 12px; color: var(--text-muted); margin-top: 2px; }
    .chart-body { padding: 16px; }
    .chart-area { height: 260px; }

    /* TABELAS */
    .tables-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
    table { width: 100%; border-collapse: collapse; }
    th { background: var(--bg); color: var(--text-muted); padding: 10px 14px; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; text-align: left; }
    td { padding: 10px 14px; font-size: 13px; border-bottom: 1px solid var(--bg); color: var(--text); }
    tr:last-child td { border-bottom: none; }
    tr:hover td { background: var(--bg); }
    .td-num { font-weight: 700; font-variant-numeric: tabular-nums; }
    .td-pct { color: var(--text-muted); font-size: 12px; }

    /* PROGRESS BAR */
    .prog-bar {
      height: 4px; border-radius: 4px; background: var(--bg); margin-top: 6px; overflow: hidden;
    }
    .prog-fill { height: 100%; border-radius: 4px; transition: width 0.8s ease; }

    /* EMPTY / LOADING */
    .empty-state { text-align: center; padding: 60px; color: var(--text-muted); }
    .empty-state i { font-size: 40px; opacity: 0.3; margin-bottom: 12px; }
    .skeleton { background: linear-gradient(90deg, #e2e8f0 25%, #f1f5f9 50%, #e2e8f0 75%); background-size: 200% 100%; animation: skeleton 1.5s infinite; border-radius: 6px; }
    @keyframes skeleton { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

    .toast {
      position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%) translateY(80px);
      background: var(--text); color: white; padding: 14px 24px; border-radius: 12px;
      font-size: 14px; font-weight: 500; display: flex; align-items: center; gap: 10px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.2); transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      z-index: 999;
    }
    .toast.show { transform: translateX(-50%) translateY(0); }
    .toast.success { background: #15803d; }
    .toast.error   { background: #b91c1c; }

    @media (max-width: 640px) {
      .charts-row { grid-template-columns: 1fr; }
      .tables-row  { grid-template-columns: 1fr; }
      .kpi-grid { grid-template-columns: repeat(2,1fr); }
    }
  </style>
</head>
<body>
  <div class="toast" id="toast"></div>
  <div class="wrapper">
    <div class="page-header">
      <div class="header-left">
        <a href="<?= baseUrl ?>" class="page-back"><i class="fas fa-arrow-left"></i></a>
        <div class="page-title">
          <h1><i class="fas fa-chart-bar" style="color:var(--purple); margin-right:8px;"></i>Relatórios</h1>
          <p id="updateTime">Carregando...</p>
        </div>
      </div>
      <div class="header-actions">
        <button class="btn btn-ghost" onclick="carregarDados()"><i class="fas fa-sync-alt"></i> Atualizar</button>
        <button class="btn btn-green" onclick="exportarCSV()"><i class="fas fa-file-csv"></i> Exportar CSV</button>
      </div>
    </div>

    <!-- KPIs -->
    <div class="kpi-grid" id="kpiGrid">
      <div class="kpi-card"><div class="skeleton" style="height:70px;"></div></div>
      <div class="kpi-card"><div class="skeleton" style="height:70px;"></div></div>
      <div class="kpi-card"><div class="skeleton" style="height:70px;"></div></div>
      <div class="kpi-card"><div class="skeleton" style="height:70px;"></div></div>
      <div class="kpi-card"><div class="skeleton" style="height:70px;"></div></div>
      <div class="kpi-card"><div class="skeleton" style="height:70px;"></div></div>
    </div>

    <!-- GRÁFICOS -->
    <div class="charts-row">
      <div class="chart-card">
        <div class="chart-header">
          <h3><i class="fas fa-chart-pie" style="color:var(--purple);"></i> Por Setor</h3>
          <p>Distribuição das ordens por área</p>
        </div>
        <div class="chart-body"><div id="chartSetor" class="chart-area"></div></div>
      </div>
      <div class="chart-card">
        <div class="chart-header">
          <h3><i class="fas fa-chart-donut" style="color:var(--orange);"></i> Por Status</h3>
          <p>Situação atual das ordens</p>
        </div>
        <div class="chart-body"><div id="chartStatus" class="chart-area"></div></div>
      </div>
    </div>

    <!-- TABELAS -->
    <div class="tables-row">
      <div class="chart-card">
        <div class="chart-header">
          <h3><i class="fas fa-exclamation-triangle" style="color:var(--orange);"></i> Por Prioridade</h3>
        </div>
        <table id="tabelaPrioridade"></table>
      </div>
      <div class="chart-card">
        <div class="chart-header">
          <h3><i class="fas fa-building" style="color:var(--blue);"></i> Por Setor (Top 8)</h3>
        </div>
        <table id="tabelaSetor"></table>
      </div>
    </div>
  </div>

  <script>
    google.charts.load('current', { packages: ['corechart'] });
    google.charts.setOnLoadCallback(carregarDados);

    function carregarDados() {
      document.getElementById('updateTime').textContent = 'Atualizando...';
      google.script.run
        .withSuccessHandler(exibirRelatorios)
        .withFailureHandler(function(err) {
          showToast('Erro ao carregar dados: ' + err.message, 'error');
          document.getElementById('updateTime').textContent = 'Erro ao carregar';
        })
        .getEstatisticas();
    }

    function exibirRelatorios(s) {
      if (!s) { showToast('Sem dados disponíveis.', 'error'); return; }
      const now = new Date();
      document.getElementById('updateTime').textContent =
        `Última atualização: ${now.toLocaleTimeString('pt-BR')}`;

      const taxa = s.total ? ((s.concluidos / s.total) * 100).toFixed(1) : '0.0';

      // KPIs
      const kpis = [
        { icon: 'fas fa-clipboard-list', color: '#2563eb', light: '#dbeafe', value: s.total, label: 'Total de Ordens' },
        { icon: 'fas fa-clock', color: '#ea580c', light: '#ffedd5', value: (s.abertos || 0) + (s.emAndamento || 0), label: 'Em Aberto' },
        { icon: 'fas fa-check-circle', color: '#16a34a', light: '#dcfce7', value: s.concluidos || 0, label: 'Concluídas' },
        { icon: 'fas fa-percent', color: '#7c3aed', light: '#ede9fe', value: taxa + '%', label: 'Taxa Conclusão' },
        { icon: 'fas fa-dollar-sign', color: '#0891b2', light: '#e0f2fe', value: 'R$ ' + (s.custoTotal || 0).toLocaleString('pt-BR',{minimumFractionDigits:2}), label: 'Custo Total' },
        { icon: 'fas fa-stopwatch', color: '#d97706', light: '#fef3c7', value: (s.tempoMedioResolucao || 0) + 'h', label: 'Tempo Médio' },
      ];
      document.getElementById('kpiGrid').innerHTML = kpis.map(k => `
        <div class="kpi-card" style="--kpi-color:${k.color}; --kpi-light:${k.light};">
          <div class="kpi-icon"><i class="${k.icon}"></i></div>
          <div class="kpi-value">${k.value}</div>
          <div class="kpi-label">${k.label}</div>
        </div>`).join('');

      // Gráfico setor
      renderPieChart('chartSetor', s.porSetor, 'Ordens por Setor');
      // Gráfico status
      renderPieChart('chartStatus', {
        'Aberto': s.abertos || 0,
        'Em Andamento': s.emAndamento || 0,
        'Concluído': s.concluidos || 0,
        'Cancelado': s.cancelados || 0
      }, 'Status das Ordens');

      // Tabela prioridade
      const prioColors = { 'Urgente': '#dc2626', 'Alta': '#ea580c', 'Média': '#2563eb', 'Baixa': '#16a34a' };
      let htmlP = '<tr><th>Prioridade</th><th>Qtd</th><th>%</th></tr>';
      for (const [p, q] of Object.entries(s.porPrioridade || {})) {
        const pct = s.total ? ((q / s.total) * 100).toFixed(1) : '0';
        const cor = prioColors[p] || '#64748b';
        htmlP += `<tr>
          <td><span style="color:${cor}; font-weight:600;">● ${p}</span></td>
          <td class="td-num">${q}</td>
          <td><span class="td-pct">${pct}%</span>
            <div class="prog-bar"><div class="prog-fill" style="width:${pct}%; background:${cor};"></div></div>
          </td>
        </tr>`;
      }
      document.getElementById('tabelaPrioridade').innerHTML = htmlP;

      // Tabela setor (top 8)
      const setoresSorted = Object.entries(s.porSetor || {}).sort((a,b) => b[1]-a[1]).slice(0,8);
      let htmlS = '<tr><th>Setor</th><th>Qtd</th><th>%</th></tr>';
      for (const [setor, q] of setoresSorted) {
        const pct = s.total ? ((q / s.total) * 100).toFixed(1) : '0';
        htmlS += `<tr>
          <td>${setor}</td>
          <td class="td-num">${q}</td>
          <td><span class="td-pct">${pct}%</span>
            <div class="prog-bar"><div class="prog-fill" style="width:${pct}%; background:var(--blue);"></div></div>
          </td>
        </tr>`;
      }
      document.getElementById('tabelaSetor').innerHTML = htmlS;
    }

    function renderPieChart(elementId, data, title) {
      const entries = Object.entries(data).filter(([,v]) => v > 0);
      if (!entries.length) {
        document.getElementById(elementId).innerHTML =
          '<div class="empty-state"><i class="fas fa-chart-pie"></i><p>Sem dados</p></div>';
        return;
      }
      const dt = new google.visualization.DataTable();
      dt.addColumn('string', 'Categoria');
      dt.addColumn('number', 'Qtd');
      dt.addRows(entries.map(([k,v]) => [k, v]));
      const colors = ['#2563eb','#16a34a','#ea580c','#7c3aed','#0891b2','#d97706','#dc2626','#64748b'];
      const options = {
        title: '',
        pieHole: 0.45,
        backgroundColor: 'transparent',
        legend: { position: 'right', textStyle: { fontName: 'Plus Jakarta Sans', fontSize: 12, color: '#64748b' } },
        pieSliceTextStyle: { fontName: 'Plus Jakarta Sans', fontSize: 11, color: '#fff' },
        chartArea: { width: '100%', height: '85%' },
        colors: colors.slice(0, entries.length),
        sliceVisibilityThreshold: 0.01,
      };
      new google.visualization.PieChart(document.getElementById(elementId)).draw(dt, options);
    }

    function exportarCSV() {
      showToast('Gerando arquivo CSV...', 'default');
      google.script.run
        .withSuccessHandler(function(res) {
          if (res.success) {
            window.open(res.url, '_blank');
            showToast('CSV gerado com sucesso!', 'success');
          } else {
            showToast(res.message, 'error');
          }
        })
        .withFailureHandler(function(err) {
          showToast('Erro: ' + err.message, 'error');
        })
        .exportarParaCSV();
    }

    function showToast(msg, tipo = 'default') {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.className = `toast show ${tipo}`;
      setTimeout(() => t.classList.remove('show'), 4000);
    }
  </script>
</body>
</html>